<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-searchbar (click)="disableInventoryMenu()" animated (ionChange)="searchProduct($event)" (ionFocus)="searchFocused()" placeholder="Product search"></ion-searchbar>
    <ion-buttons slot="end" *ngIf="is_cordova">
      <ion-button class="barcode" (click)="scanBarcode()">
        <ion-icon slot="icon-only" name="qr-scanner"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div *ngIf="searching">
    <ion-list class="hide-last-border" *ngIf="!search_loading">
      <ion-item button *ngFor="let item of items" (click)="selectProduct(item.item_code)" detail>
        <ion-avatar slot="start">
          <img src="{{ item.image_url }}">
        </ion-avatar>
        <ion-label>
          <h2>{{ item.name }}</h2>
          <p>Item code: {{ item.item_code }}</p>
          <p>PLU: {{ item.plu }} ({{ item.plu_number }})</p>
        </ion-label>
      </ion-item>
    </ion-list>
    <div class="loading-container" *ngIf="search_loading">
      <ion-spinner></ion-spinner>
    </div>
    <div class="empty-search" *ngIf="empty_search">
      Search by product name, PLU, or item code
    </div>
    <div class="no-results" *ngIf="!search_loading && search_no_results">
      No products found
    </div>
  </div>
  <div *ngIf="!searching">
    <ion-segment padding (ionChange)="segmentChanged($event)" [(ngModel)]="current_tab">
      <ion-segment-button checked="true" value="details">
        <ion-label>Details</ion-label>
      </ion-segment-button>
      <ion-segment-button (click)="disableInventoryMenu()" value="movement">
        <ion-label>Movement</ion-label>
      </ion-segment-button>
      <ion-segment-button (click)="disableInventoryMenu()" value="forecast">
        <ion-label>Forecast</ion-label>
      </ion-segment-button>
    </ion-segment>
    <div *ngIf="item">
      <div [ngSwitch]="current_tab">
        <div *ngSwitchCase="'details'">
          <div *ngIf="!product_loading">
            <img class="product-detail-image" [src]="item.image_url">

            <h5 class="product-name">{{ item.name }}</h5>

            <ion-list>
              <ion-item>
                <ion-label>
                  PLU <span class="float-right">{{ item.plu }} ({{ item.plu_number }})</span>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-label>
                  Price per {{ item.unit }} <span class="float-right">{{ item.price | currency }}</span>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-label>
                  Inventory <span class="float-right"> {{item.current_inventory}} {{item.unit}}s </span> <span class ="float-right"></span>
                  <br>
                  <span class="float-right"><ion-button (click)="toggleInventoryMenu()">Edit</ion-button></span>
                </ion-label>
              </ion-item>
              <div *ngIf="inventoryMenu && current_tab == 'details'">
                <ion-grid no-padding>
                  <ion-row>
                    <ion-col>
                      <ion-button size="large" (click)="plusButton()"><ion-icon name="add"></ion-icon></ion-button>
                      <br>
                      <ion-button size="large" (click)="minusButton()"><ion-icon name="remove"></ion-icon></ion-button>
                    </ion-col>
                    <ion-col align-self: center>
                      <br>
                      <br>
                      <ion-item>
                      <ion-input text-center [(ngModel)]="tempInventory"></ion-input>
                      </ion-item>
                    </ion-col>
                    <ion-col></ion-col>
                  </ion-row>
                  <ion-row>
                    <ion-col><ion-button expand="block" color="success" (click)="updateInventory()">Update</ion-button></ion-col>
                    <ion-col><ion-button expand="block" color="danger" (click)="toggleInventoryMenu()">Cancel</ion-button></ion-col>
                  </ion-row>
                </ion-grid>
              </div>

              <ion-item>
                <ion-label>
                  Item code <span class="float-right">{{ item_code }}</span>
                </ion-label>
              </ion-item>
            </ion-list>
          </div>
        </div>
        <div *ngSwitchCase="'movement'">
          <div *ngIf="movement && !movement_loading">
            <h5 class="product-name">{{ item.name }}</h5>
            <p class="helper-text">Movement by {{ item.unit | lowercase }}s sold for the past week</p>
            <ion-segment class="small-center" padding (ionChange)="movementDisplayChanged($event)">
              <ion-segment-button checked="true" value="table">
                <ion-label>Table</ion-label>
              </ion-segment-button>
              <ion-segment-button value="graph">
                <ion-label>Graph</ion-label>
              </ion-segment-button>
            </ion-segment>
            <ion-list class="hide-last-border" *ngIf="movement_display == 'table'">
              <ion-item *ngFor="let item of movement; index as i">
                <ion-label>
                  {{ item.date.format('ddd (M/D)') }} 
                  <span *ngIf="i == 0">(Today)</span>
                  <span *ngIf="i == 1">(Yesterday)</span>
                  <span class="float-right">{{ item.amount }}</span>
                </ion-label>
              </ion-item>
            </ion-list>
            <ion-grid *ngIf="movement_display == 'table'">
              <ion-row text-center>
                <ion-col><ion-badge>Sun</ion-badge></ion-col><ion-col><ion-badge>Mon</ion-badge></ion-col><ion-col>Tues</ion-col><ion-col>Wed</ion-col><ion-col>Thurs</ion-col><ion-col>Fri</ion-col><ion-col>Sat</ion-col><ion-col>Sun</ion-col>
              </ion-row>
              <ion-row text-center>
                <ion-col>4/12</ion-col><ion-col>4/13</ion-col><ion-col>Tues</ion-col><ion-col>Wed</ion-col><ion-col>Thurs</ion-col><ion-col>Fri</ion-col><ion-col>Sat</ion-col><ion-col>Sun</ion-col>
              </ion-row>
              <ion-row text-center>
                <ion-col>0</ion-col><ion-col>1</ion-col><ion-col>2</ion-col><ion-col>3</ion-col><ion-col>4</ion-col><ion-col>5</ion-col><ion-col>6</ion-col><ion-col>7</ion-col>
              </ion-row>
            </ion-grid>
          </div>
          <div class="row chart-row" *ngIf="movement_display == 'graph'">
            <div class="chart">
              <div style="display: block;">
              <canvas baseChart #baseChart="base-chart" width="300" height="400"
                          [datasets]="movementChartData"
                          [labels]="movementChartLabels"
                          [options]="lineChartOptions"
                          [colors]="lineChartColors"
                          [legend]="lineChartLegend"
                          [chartType]="lineChartType"
                          (chartHover)="chartHovered($event)"
                          (chartClick)="chartClicked($event)"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div *ngSwitchCase="'forecast'">
          <div *ngIf="forecast && !forecast_loading">
            <h5 class="product-name">{{ item.name }}</h5>
            <p class="helper-text">Forecast by {{ item.unit | lowercase }}s sold for the next week</p>
            <ion-segment class="small-center" padding (ionChange)="forecastDisplayChanged($event)">
              <ion-segment-button checked="true" value="table">
                <ion-label>Table</ion-label>
              </ion-segment-button>
              <ion-segment-button value="graph">
                <ion-label>Graph</ion-label>
              </ion-segment-button>
            </ion-segment>
            <ion-list class="hide-last-border" *ngIf="forecast_display == 'table'">
              <ion-item *ngFor="let item of forecast; index as i">
                <ion-label>
                  {{ item.date.format('ddd (M/D)') }} 
                  <span *ngIf="i == 0">(Today)</span>
                  <span *ngIf="i == 1">(Tomorrow)</span>
                  <span class="float-right">{{ item.amount }}</span>
                </ion-label>
              </ion-item>
            </ion-list>
          </div>
          <div class="row chart-row" *ngIf="forecast_display == 'graph'">
            <div class="chart">
              <div style="display: block;">
              <canvas baseChart #baseChart="base-chart" width="300" height="400"
                          [datasets]="forecastChartData"
                          [labels]="forecastChartLabels"
                          [options]="lineChartOptions"
                          [colors]="lineChartColors"
                          [legend]="lineChartLegend"
                          [chartType]="lineChartType"
                          (chartHover)="chartHovered($event)"
                          (chartClick)="chartClicked($event)"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="loading-container" *ngIf="(product_loading && current_tab == 'details') || (movement_loading && current_tab == 'movement') || (forecast_loading && current_tab == 'forecast')">
      <ion-spinner></ion-spinner>
    </div>
  </div>
</ion-content>



